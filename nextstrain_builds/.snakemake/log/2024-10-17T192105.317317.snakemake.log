Building DAG of jobs...
Using shell: /usr/bin/bash
Provided cores: 16
Rules claiming more threads will be scaled down.
Provided resources: mem_mb=65536
Conda environments: ignored
Job stats:
job                                         count
----------------------------------------  -------
align                                           1
all                                             1
ancestral                                       1
annotate_haplotypes                             1
annotate_metadata_with_reference_strains        1
build_reference_strains_table                   1
clades                                          1
distances                                       1
download_sequences                              1
export                                          1
final_tip_frequencies                           1
glyc                                            1
join_metadata                                   1
lbi                                             1
mask                                            1
parse                                           1
prune_outliers                                  1
prune_reference                                 1
refine                                          1
sanitize_trees                                  1
select_sequences                                1
select_strains                                  1
subsample                                       1
tip_frequencies                                 1
traits                                          1
tree                                            1
total                                          26

Select jobs to execute...

[Thu Oct 17 19:21:06 2024]
Job 11: Downloading sequences from fauna
Reason: Missing output files: data/h3n2/raw_ha.fasta


        python3 ../fauna/vdb/download.py             --database vdb             --virus flu             --fasta_fields strain virus locus accession collection_date virus_inclusion_date region country division location passage passage_category originating_lab submitting_lab age gender             --resolve_method split_passage             --select locus:ha lineage:seasonal_h3n2             --path data             --fstem h3n2/raw_ha 2>&1 | tee logs/download_sequences_h3n2_ha.txt
        

[Thu Oct 17 19:21:06 2024]
rule build_reference_strains_table:
    input: config/h3n2/reference_strains.txt
    output: data/h3n2/reference_strains.tsv
    log: logs/build_reference_strains_table_h3n2.txt
    jobid: 15
    benchmark: benchmarks/build_reference_strains_table_h3n2.txt
    reason: Missing output files: data/h3n2/reference_strains.tsv
    wildcards: lineage=h3n2
    resources: tmpdir=/tmp


        csvtk add-header             --names strain             config/h3n2/reference_strains.txt             | csvtk uniq             | csvtk --out-tabs mutate2                 --name is_reference                 --expression "'True'" > data/h3n2/reference_strains.tsv
        
Benchmark: unable to collect cpu and memory benchmark statistics
[Thu Oct 17 19:21:06 2024]
Finished job 15.
1 of 26 steps (4%) done
[Thu Oct 17 19:24:40 2024]
Finished job 11.
2 of 26 steps (8%) done
Select jobs to execute...

[Thu Oct 17 19:24:40 2024]
Job 10: Parsing fasta into sequences and metadata
Reason: Missing output files: data/h3n2/ha.fasta, data/h3n2/metadata_ha.tsv; Input files updated by another job: data/h3n2/raw_ha.fasta


        augur parse             --sequences data/h3n2/raw_ha.fasta             --output-sequences data/h3n2/ha.fasta             --output-metadata data/h3n2/metadata_ha.tsv             --fields strain virus segment accession date date_submitted region country division location passage passage_category originating_lab submitting_lab age gender             --prettify-fields region country division location originating_lab submitting_lab 2>&1 | tee logs/parse_h3n2_ha.txt
        
[Thu Oct 17 19:24:49 2024]
Finished job 10.
3 of 26 steps (12%) done
Select jobs to execute...

[Thu Oct 17 19:24:49 2024]
rule join_metadata:
    input: data/h3n2/metadata_ha.tsv
    output: data/h3n2/metadata_joined.tsv
    log: logs/join_metadata_h3n2.txt
    jobid: 14
    benchmark: benchmarks/join_metadata_h3n2.txt
    reason: Missing output files: data/h3n2/metadata_joined.tsv; Input files updated by another job: data/h3n2/metadata_ha.tsv
    wildcards: lineage=h3n2
    resources: tmpdir=/tmp


        python3 scripts/join_metadata.py             --metadata data/h3n2/metadata_ha.tsv             --segments ha             --segment-columns accession             --how outer             --output data/h3n2/metadata_joined.tsv 2>&1 | tee logs/join_metadata_h3n2.txt
        
[Thu Oct 17 19:24:51 2024]
Finished job 14.
4 of 26 steps (15%) done
Select jobs to execute...

[Thu Oct 17 19:24:51 2024]
rule annotate_metadata_with_reference_strains:
    input: data/h3n2/metadata_joined.tsv, data/h3n2/reference_strains.tsv
    output: data/h3n2/metadata.tsv
    log: logs/annotate_metadata_with_reference_strains_h3n2.txt
    jobid: 13
    benchmark: benchmarks/annotate_metadata_with_reference_strains_h3n2.txt
    reason: Missing output files: data/h3n2/metadata.tsv; Input files updated by another job: data/h3n2/metadata_joined.tsv, data/h3n2/reference_strains.tsv
    wildcards: lineage=h3n2
    resources: tmpdir=/tmp


        csvtk --tabs join             --left-join             --na "False"             -f "strain"             data/h3n2/metadata_joined.tsv             data/h3n2/reference_strains.tsv > data/h3n2/metadata.tsv
        
[Thu Oct 17 19:24:52 2024]
Finished job 13.
5 of 26 steps (19%) done
Select jobs to execute...

[Thu Oct 17 19:24:52 2024]
rule subsample:
    input: data/h3n2/metadata.tsv
    output: builds/h3n2_30y/strains_global.txt, builds/h3n2_30y/strains_global_filter_log.tsv
    log: logs/subsample_h3n2_30y_global.txt
    jobid: 16
    benchmark: benchmarks/subsample_h3n2_30y_global.txt
    reason: Missing output files: builds/h3n2_30y/strains_global.txt; Input files updated by another job: data/h3n2/metadata.tsv
    wildcards: build_name=h3n2_30y, subsample=global
    resources: tmpdir=/tmp


        augur filter             --metadata data/h3n2/metadata.tsv             --group-by region year --subsample-max-sequences 4000 --min-date 1994-10-25 --include-where 'passage_category=egg' --exclude config_30y/h3n2/outliers.txt --exclude-where 'ha!=True' 'na!=True'                          --output-strains builds/h3n2_30y/strains_global.txt             --output-log builds/h3n2_30y/strains_global_filter_log.tsv 2>&1 | tee logs/subsample_h3n2_30y_global.txt
        
[Thu Oct 17 19:25:14 2024]
Finished job 16.
6 of 26 steps (23%) done
Select jobs to execute...

[Thu Oct 17 19:25:14 2024]
rule select_strains:
    input: data/h3n2/metadata.tsv, builds/h3n2_30y/strains_global.txt
    output: builds/h3n2_30y/metadata.tsv, builds/h3n2_30y/strains.txt
    log: logs/select_strains_h3n2_30y.txt
    jobid: 12
    benchmark: benchmarks/select_strains_h3n2_30y.txt
    reason: Missing output files: builds/h3n2_30y/metadata.tsv, builds/h3n2_30y/strains.txt; Input files updated by another job: data/h3n2/metadata.tsv, builds/h3n2_30y/strains_global.txt
    wildcards: build_name=h3n2_30y
    resources: tmpdir=/tmp


        augur filter             --metadata data/h3n2/metadata.tsv             --exclude-all             --include builds/h3n2_30y/strains_global.txt             --output-metadata builds/h3n2_30y/metadata.tsv             --output-strains builds/h3n2_30y/strains.txt 2>&1 | tee logs/select_strains_h3n2_30y.txt
        
[Thu Oct 17 19:25:16 2024]
Finished job 12.
7 of 26 steps (27%) done
Select jobs to execute...

[Thu Oct 17 19:25:16 2024]
rule select_sequences:
    input: data/h3n2/ha.fasta, builds/h3n2_30y/metadata.tsv, builds/h3n2_30y/strains.txt
    output: builds/h3n2_30y/ha/sequences.fasta
    log: logs/select_sequences_h3n2_30y_ha.txt
    jobid: 9
    benchmark: benchmarks/select_sequences_h3n2_30y_ha.txt
    reason: Missing output files: builds/h3n2_30y/ha/sequences.fasta; Input files updated by another job: data/h3n2/ha.fasta, builds/h3n2_30y/metadata.tsv, builds/h3n2_30y/strains.txt
    wildcards: build_name=h3n2_30y, segment=ha
    resources: tmpdir=/tmp


        augur filter             --sequences data/h3n2/ha.fasta             --metadata builds/h3n2_30y/metadata.tsv             --exclude-all             --include builds/h3n2_30y/strains.txt             --output-sequences builds/h3n2_30y/ha/sequences.fasta 2>&1 | tee logs/select_sequences_h3n2_30y_ha.txt
        
[Thu Oct 17 19:25:19 2024]
Finished job 9.
8 of 26 steps (31%) done
Select jobs to execute...

[Thu Oct 17 19:25:19 2024]
rule mask:
    input: builds/h3n2_30y/ha/sequences.fasta
    output: builds/h3n2_30y/ha/masked.fasta
    log: logs/mask_h3n2_30y_ha.txt
    jobid: 8
    benchmark: benchmarks/mask_h3n2_30y_ha.txt
    reason: Missing output files: builds/h3n2_30y/ha/masked.fasta; Input files updated by another job: builds/h3n2_30y/ha/sequences.fasta
    wildcards: build_name=h3n2_30y, segment=ha
    resources: tmpdir=/tmp


        augur mask             --sequences builds/h3n2_30y/ha/sequences.fasta             --mask-invalid             --output builds/h3n2_30y/ha/masked.fasta 2>&1 | tee logs/mask_h3n2_30y_ha.txt
        
[Thu Oct 17 19:25:21 2024]
Finished job 8.
9 of 26 steps (35%) done
Select jobs to execute...

[Thu Oct 17 19:25:21 2024]
Job 7: 
        Aligning sequences to config_30y/h3n2/ha/reference.fasta
        
Reason: Missing output files: builds/h3n2_30y/ha/aligned.fasta; Input files updated by another job: builds/h3n2_30y/ha/masked.fasta
DAG of jobs will be updated after completion.


        nextalign run            -r config_30y/h3n2/ha/reference.fasta             -m config_30y/h3n2/ha/genemap.gff             --genes SigPep,HA1,HA2             --jobs 8             --include-reference             builds/h3n2_30y/ha/masked.fasta             --output-fasta builds/h3n2_30y/ha/aligned.fasta             --output-translations "builds/h3n2_30y/ha/nextalign/masked.gene.{gene}.fasta" 2>&1 | tee logs/align_h3n2_30y_ha.txt
        
[Thu Oct 17 19:25:22 2024]
Finished job 7.
10 of 26 steps (38%) done
Select jobs to execute...

[Thu Oct 17 19:25:22 2024]
Job 6: Building tree
Reason: Missing output files: builds/h3n2_30y/ha/tree_raw.nwk


        augur tree             --method iqtree             --alignment builds/h3n2_30y/ha/aligned.fasta             --tree-builder-args '-ninit 10 -n 4 -czb'                          --output builds/h3n2_30y/ha/tree_raw.nwk             --nthreads 8 2>&1 | tee logs/tree_h3n2_30y_ha.txt
        
[Thu Oct 17 19:32:17 2024]
Finished job 6.
11 of 26 steps (42%) done
Select jobs to execute...

[Thu Oct 17 19:32:17 2024]
rule prune_reference:
    input: builds/h3n2_30y/ha/tree_raw.nwk, config_30y/h3n2/ha/reference.fasta
    output: builds/h3n2_30y/ha/tree_without_outgroup.nwk
    jobid: 5
    reason: Missing output files: builds/h3n2_30y/ha/tree_without_outgroup.nwk; Input files updated by another job: builds/h3n2_30y/ha/tree_raw.nwk
    wildcards: build_name=h3n2_30y, segment=ha
    resources: tmpdir=/tmp


        python3 scripts/prune_reference.py             --tree builds/h3n2_30y/ha/tree_raw.nwk             --reference config_30y/h3n2/ha/reference.fasta             --output builds/h3n2_30y/ha/tree_without_outgroup.nwk
        
[Thu Oct 17 19:32:18 2024]
Finished job 5.
12 of 26 steps (46%) done
Select jobs to execute...

[Thu Oct 17 19:32:18 2024]
rule prune_outliers:
    input: builds/h3n2_30y/ha/tree_without_outgroup.nwk, builds/h3n2_30y/ha/aligned.fasta, builds/h3n2_30y/metadata.tsv
    output: builds/h3n2_30y/ha/tree_without_outgroup_clean.nwk, builds/h3n2_30y/ha/outliers.tsv
    jobid: 4
    reason: Missing output files: builds/h3n2_30y/ha/tree_without_outgroup_clean.nwk; Input files updated by another job: builds/h3n2_30y/ha/tree_without_outgroup.nwk
    wildcards: build_name=h3n2_30y, segment=ha
    resources: tmpdir=/tmp


        python3 scripts/flag_outliers.py             --tree builds/h3n2_30y/ha/tree_without_outgroup.nwk             --aln builds/h3n2_30y/ha/aligned.fasta             --dates builds/h3n2_30y/metadata.tsv             --cutoff 4.0             --keep-strains config_30y/h3n2/reference_and_egg_strains.txt             --output-tree builds/h3n2_30y/ha/tree_without_outgroup_clean.nwk --output-outliers builds/h3n2_30y/ha/outliers.tsv 2>&1 | tee 
        
[Thu Oct 17 19:32:41 2024]
Finished job 4.
13 of 26 steps (50%) done
Select jobs to execute...

[Thu Oct 17 19:32:41 2024]
rule sanitize_trees:
    input: builds/h3n2_30y/ha/tree_without_outgroup_clean.nwk, builds/h3n2_30y/ha/aligned.fasta
    output: builds/h3n2_30y/ha/tree_common.nwk
    log: logs/sanitize_trees_h3n2_30y.txt
    jobid: 3
    benchmark: benchmarks/sanitize_trees_h3n2_30y.txt
    reason: Missing output files: builds/h3n2_30y/ha/tree_common.nwk; Input files updated by another job: builds/h3n2_30y/ha/tree_without_outgroup_clean.nwk
    wildcards: build_name=h3n2_30y
    resources: tmpdir=/tmp


        python3 scripts/sanitize_trees.py             --trees builds/h3n2_30y/ha/tree_without_outgroup_clean.nwk             --alignments builds/h3n2_30y/ha/aligned.fasta             --output builds/h3n2_30y/ha/tree_common.nwk 2>&1 | tee logs/sanitize_trees_h3n2_30y.txt
        
[Thu Oct 17 19:33:15 2024]
Finished job 3.
14 of 26 steps (54%) done
Select jobs to execute...

[Thu Oct 17 19:33:15 2024]
Job 2: 
        Refining tree
          - estimate timetree
          - use const coalescent timescale
          - estimate marginal node dates
          - filter tips more than 4 IQDs from clock expectation
        
Reason: Missing output files: builds/h3n2_30y/ha/tree.nwk, builds/h3n2_30y/ha/branch-lengths.json; Input files updated by another job: builds/h3n2_30y/ha/tree_common.nwk


        augur refine             --tree builds/h3n2_30y/ha/tree_common.nwk             --alignment builds/h3n2_30y/ha/aligned.fasta             --metadata builds/h3n2_30y/metadata.tsv             --output-tree builds/h3n2_30y/ha/tree.nwk             --output-node-data builds/h3n2_30y/ha/branch-lengths.json             --keep-root             --stochastic-resolve             --timetree             --use-fft             --no-covariance             --clock-rate 0.00382             --clock-std-dev 0.000764             --coalescent const             --date-confidence             --date-inference marginal             --clock-filter-iqd 4 2>&1 | tee logs/refine_h3n2_30y_ha.txt
        
[Thu Oct 17 19:53:35 2024]
Finished job 2.
15 of 26 steps (58%) done
Select jobs to execute...

[Thu Oct 17 19:53:35 2024]
Job 22: Calculating LBI
Reason: Missing output files: builds/h3n2_30y/ha/lbi.json; Input files updated by another job: builds/h3n2_30y/ha/tree.nwk, builds/h3n2_30y/ha/branch-lengths.json


        augur lbi             --tree builds/h3n2_30y/ha/tree.nwk             --branch-lengths builds/h3n2_30y/ha/branch-lengths.json             --output builds/h3n2_30y/ha/lbi.json             --attribute-names lbi             --tau 0.5             --window 0.5 2>&1 | tee logs/lbi_h3n2_30y_ha.txt
        

[Thu Oct 17 19:53:35 2024]
Job 19: 
        Inferring ancestral traits for region
        
Reason: Missing output files: builds/h3n2_30y/ha/traits.json; Input files updated by another job: builds/h3n2_30y/ha/tree.nwk, builds/h3n2_30y/metadata.tsv


        augur traits             --tree builds/h3n2_30y/ha/tree.nwk             --metadata builds/h3n2_30y/metadata.tsv             --output builds/h3n2_30y/ha/traits.json             --columns region             --confidence 2>&1 | tee logs/traits_h3n2_30y_ha.txt
        

[Thu Oct 17 19:53:35 2024]
rule tip_frequencies:
    input: builds/h3n2_30y/ha/tree.nwk, builds/h3n2_30y/metadata.tsv
    output: builds/h3n2_30y/ha/tip-frequencies.json
    log: logs/tip_frequencies_h3n2_30y_ha.txt
    jobid: 25
    benchmark: benchmarks/tip_frequencies_h3n2_30y_ha.txt
    reason: Missing output files: builds/h3n2_30y/ha/tip-frequencies.json; Input files updated by another job: builds/h3n2_30y/ha/tree.nwk, builds/h3n2_30y/metadata.tsv
    wildcards: build_name=h3n2_30y, segment=ha
    resources: tmpdir=/tmp


        augur frequencies             --method kde             --tree builds/h3n2_30y/ha/tree.nwk             --metadata builds/h3n2_30y/metadata.tsv             --narrow-bandwidth 0.08333333333333333             --wide-bandwidth 0.25             --proportion-wide 0.0             --pivot-interval 1             --min-date 1994-10-25             --max-date 0D             --output builds/h3n2_30y/ha/tip-frequencies.json 2>&1 | tee logs/tip_frequencies_h3n2_30y_ha.txt
        

[Thu Oct 17 19:53:35 2024]
Job 17: Reconstructing ancestral sequences and mutations
Reason: Missing output files: builds/h3n2_30y/ha/muts.json, builds/h3n2_30y/ha/translations.done; Input files updated by another job: builds/h3n2_30y/ha/tree.nwk


        augur ancestral             --tree builds/h3n2_30y/ha/tree.nwk             --alignment builds/h3n2_30y/ha/aligned.fasta             --root-sequence config_30y/h3n2/ha/reference.fasta             --annotation config_30y/h3n2/ha/genemap.gff             --genes SigPep HA1 HA2             --translations "builds/h3n2_30y/ha/nextalign/masked.gene.%GENE.fasta"             --output-node-data builds/h3n2_30y/ha/muts.json             --output-translations "builds/h3n2_30y/ha/nextalign/masked.gene.%GENE_withInternalNodes.fasta"             --inference joint 2>&1 | tee logs/ancestral_h3n2_30y_ha.txt && touch builds/h3n2_30y/ha/translations.done
        
[Thu Oct 17 19:53:37 2024]
Finished job 22.
16 of 26 steps (62%) done
[Thu Oct 17 19:53:45 2024]
Finished job 25.
17 of 26 steps (65%) done
Select jobs to execute...

[Thu Oct 17 19:53:45 2024]
rule final_tip_frequencies:
    input: builds/h3n2_30y/ha/tip-frequencies.json
    output: auspice/h3n2_30y_ha_tip-frequencies.json
    jobid: 24
    reason: Missing output files: auspice/h3n2_30y_ha_tip-frequencies.json; Input files updated by another job: builds/h3n2_30y/ha/tip-frequencies.json
    wildcards: build_name=h3n2_30y, segment=ha
    resources: tmpdir=/tmp


        cp -f builds/h3n2_30y/ha/tip-frequencies.json auspice/h3n2_30y_ha_tip-frequencies.json
        
[Thu Oct 17 19:53:45 2024]
Finished job 24.
18 of 26 steps (69%) done
[Thu Oct 17 19:54:20 2024]
Error in rule ancestral:
    jobid: 17
    input: builds/h3n2_30y/ha/tree.nwk, builds/h3n2_30y/ha/aligned.fasta, builds/h3n2_30y/ha/nextalign/masked.gene.SigPep.fasta, builds/h3n2_30y/ha/nextalign/masked.gene.HA1.fasta, builds/h3n2_30y/ha/nextalign/masked.gene.HA2.fasta, config_30y/h3n2/ha/reference.fasta, config_30y/h3n2/ha/genemap.gff
    output: builds/h3n2_30y/ha/muts.json, builds/h3n2_30y/ha/translations.done
    log: logs/ancestral_h3n2_30y_ha.txt (check log file(s) for error details)
    conda-env: /nextstrain/build/.snakemake/conda/fc1987361f719b595054c683e8c932d5_
    shell:
        
        augur ancestral             --tree builds/h3n2_30y/ha/tree.nwk             --alignment builds/h3n2_30y/ha/aligned.fasta             --root-sequence config_30y/h3n2/ha/reference.fasta             --annotation config_30y/h3n2/ha/genemap.gff             --genes SigPep HA1 HA2             --translations "builds/h3n2_30y/ha/nextalign/masked.gene.%GENE.fasta"             --output-node-data builds/h3n2_30y/ha/muts.json             --output-translations "builds/h3n2_30y/ha/nextalign/masked.gene.%GENE_withInternalNodes.fasta"             --inference joint 2>&1 | tee logs/ancestral_h3n2_30y_ha.txt && touch builds/h3n2_30y/ha/translations.done
        
        (one of the commands exited with non-zero exit code; note that snakemake uses bash strict mode!)
Logfile logs/ancestral_h3n2_30y_ha.txt:
================================================================================
ERROR: The 'nuc' annotation coordinates parsed from 'config_30y/h3n2/ha/genemap.gff' (1..1737) don't match the provided sequence data coordinates (1..1765).

Inferred ancestral sequence states using TreeTime:
	Sagulenko et al. TreeTime: Maximum-likelihood phylodynamic analysis
	Virus Evolution, vol 4, https://academic.oup.com/ve/article/4/1/vex042/4794731

augur ancestral is using TreeTime version 0.11.4
================================================================================

[Thu Oct 17 19:54:47 2024]
Finished job 19.
19 of 26 steps (73%) done
Shutting down, this might take some time.
Exiting because a job execution failed. Look above for error message
Complete log: .snakemake/log/2024-10-17T192105.317317.snakemake.log
